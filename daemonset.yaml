apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: twistlock-view
rules:
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"] # Allow Defenders to list RBAC resources
  verbs: ["list"]
---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: twistlock-view-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: twistlock-view
subjects:
- apiGroup:
  kind: ServiceAccount
  name: twistlock-service
  namespace: twistlock
---

---
apiVersion: v1
kind: Secret
metadata:
  name: twistlock-secrets
  namespace: twistlock
type: Opaque
data:
  service-parameter: UndaS1Bxc2tCQ0tsQlVDOCs1RmloZjUzSi91ZUI1M3Fma1h2UjloVjFBOU5OTjhGcHEzbnVBZmJUUitUU3U4MjVMZGxVdnlrWjZIYmRNbVJtUXVKcVE9PQ==
  defender-ca.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURIVENDQWdXZ0F3SUJBZ0lSQVAvcXZZSjRybzl5eTV6em82aWJ6Nkl3RFFZSktvWklodmNOQVFFTEJRQXcKS0RFU01CQUdBMVVFQ2hNSlZIZHBjM1JzYjJOck1SSXdFQVlEVlFRREV3bFVkMmx6ZEd4dlkyc3dIaGNOTWpNdwpNekk1TURrd016QXdXaGNOTWpZd016STRNRGt3TXpBd1dqQW9NUkl3RUFZRFZRUUtFd2xVZDJsemRHeHZZMnN4CkVqQVFCZ05WQkFNVENWUjNhWE4wYkc5amF6Q0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0MKZ2dFQkFMa2daMmZsTWIrUnUxeEFpNS90VWY4Y0hoM09XRmd2SFhid0lNa2I1M0xVbXMydDdTcTRwcEQ5Q0NQcwpQWjZjUE80bG9mY25yTnY4bjB3UkROdklMcGpCYjZwbFhMeVdNV0N4SUk1d3JPbGdHc0I5TEN6UzB6U0dUY1FNCm5OTWZiTGhnN2JBZ25NeWF2Zy9LMmxTSElsUVBRejM4Wk9mSlovV3BJUUtxU3Q2S2RiMW81TjdneTBwTlZ0L1MKYS9hald3NWZuK0o1WFM1ZGhlQXUxQXdFVEZ6WUtldVFIak5wMVJsRnJIeHdLU0wxN0JQcHhCcHdKWWpER2l6QQo5YUNXU0RwbExKaGhqZlVFMWlnbElRSGRyU25DZWMxK2hvSUh6a0JXUGFyd0hKRDNGRWVVOHYyTkorNmhsZEtECjNISlhwNGxwWC9iRlVhdFlCWVByM0dsNlQ1OENBd0VBQWFOQ01FQXdEZ1lEVlIwUEFRSC9CQVFEQWdLc01BOEcKQTFVZEV3RUIvd1FGTUFNQkFmOHdIUVlEVlIwT0JCWUVGQWE3UlRtWFZ0WnVXaG96OEF1MDZnbjQvK3JFTUEwRwpDU3FHU0liM0RRRUJDd1VBQTRJQkFRQjMrOElJYWxBRWQvMWVGRDh0K0l4TnhOTm5udFlZMnR0cHQxRkFQM1FxCmxZdU4ySk5lQ3VEaEo0VXh1V2R4WWk5cW5IQ0ZrVjZocVllS3NxdkVFZXBIcnFBdmJCM1JubkZnSHkvenRDc2gKdXJadE1YbklHbnhnOFBFYjFXL3BPalRidW9sRGdsZUh5VjVKZEdFb2dBTzBMTjU3bWtNTnJSUzBQMDR6dmc0WAp4d0hacHJ2TWZmV1ZYT21taHo4b2M1YzdreGRvTmUydXIrUXhaS29lRVlZZ1NGUjhzay9zYXlwUjUzRk5waGF4ClRBZi9iblMvblp1TGJwRUpyKzR6UnpkbWRwRUR1SC85YWl1eGJGc01NUy9MZG05NTEyZVM0MUdDc2Z3YVFSV1UKT0dTdHRVL25GVG5Pek1CQmtsY3FMOVRUaUhXYnJwNVQ5YWYrYkMvRGE2ZXoKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  defender-client-cert.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURQRENDQWlTZ0F3SUJBZ0lSQU1hbSs2T2NOcitLcUI2OXUrWlZBd2t3RFFZSktvWklodmNOQVFFTEJRQXcKS0RFU01CQUdBMVVFQ2hNSlZIZHBjM1JzYjJOck1SSXdFQVlEVlFRREV3bFVkMmx6ZEd4dlkyc3dIaGNOTWpNdwpNekk1TURrd016QXdXaGNOTWpZd016STRNRGt3TXpBd1dqQW9NUkl3RUFZRFZRUUtFd2xVZDJsemRHeHZZMnN4CkVqQVFCZ05WQkFNVENXeHZZMkZzYUc5emREQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0MKZ2dFQkFPZkJ0NEZUQmsvK21HRnBCb1ZWN3RNZTVtS2N1emxIcFNOd3dlakZldGxsTHpUSGxMVU9iOUJOTE5BZApiM3dWS3RiQndraGxVa1YxY1JaZVRDbk1DN1pkVmpNckNuYXV0LzRKRGh1WURRa096OVYxT09hTWhZNkVZdEJQCi8wem5sQ0F0ZmQxbk5wazlPZ2FlOFBCQS9yL1JYcWROYzJvMFJZVEZTNG5wRFBBUzJQSXVPVmMxMGZ3NzdkOHMKbGZobzJyVEpKM3pmR3B1dWE1V2k3WEpuSmtXSkR2a3g5bkZYUGxFekRKcFJTbHlSV0Z3ZHNEeCtYaHBpWHIrcApsSGNja2txSmFoSm5FQkdVYlR3cVl4NnpVQzZxYWlSK1N6dnI1NjBzQjJRL2RjUTR2UUdLQ2lBNlhqSi9TUGV5ClR1THh5WXRMRlJnSWJ1TXFieFl6OUU5dlBla0NBd0VBQWFOaE1GOHdEZ1lEVlIwUEFRSC9CQVFEQWdlQU1CTUcKQTFVZEpRUU1NQW9HQ0NzR0FRVUZCd01DTUF3R0ExVWRFd0VCL3dRQ01BQXdId1lEVlIwakJCZ3dGb0FVQnJ0RgpPWmRXMW01YUdqUHdDN1RxQ2ZqLzZzUXdDUVlGS2dRQkFnY0VBREFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBCk9EV2JGclBEQUNQczRBeFlVeVFzUEhESy9JUTBTNCtGK3ZkZzFjbEl1amI5UllFMDVSN1hXVzY0RmN0SEhDQksKbmVXang1V3dCdGpPdDdnODduczhvQlZRbkZTMENxcCt4QmYzemgwOVZJRm1ld2hJTStRa0Z3c09EeVdtMExudApiSndZUGZnbnUxemxGSXRVR3NxMzQzcWN1d3IwWC9CSUVEV01wSGV6ZWkreXRTaERMWmt4MUpodDIySHZFVUlhCmhNN1MrK05rZTlyNlAzekV3REtpQ2w3VXNIUWNCSzJQRlFWc2ZsU1F1aWFIQWJBNG05ZUdJcjZMampJTUpDMk0Kc0JUWnczdzZZcUViSzNKeng4eDBqN0g2SnVaSFlVeHJ1SXhBbHZxNzY3Mk1INzN5YkdjNzdXelY3d253TzQ5QQpqTnRmS2VONVU5WElJNUdCNzZsNGNnPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  defender-client-key.pem: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpQcm9jLVR5cGU6IDQsRU5DUllQVEVECkRFSy1JbmZvOiBBRVMtMjU2LUNCQywwN2Q1ZDkyNzFhZWUwYzcwODYxYTY5NTUzMDQ5MGM5NAoKOUpONmNid3lIZ1BaRHJQdXpSbDNqVExWN1BDWDBPbmhRL2s4N3JjdExtQmtTdnRhWHV2MVB2M2wvMWQ3TUNhWQp4dnM5MVlMV2t6RHFrVDFnbjQ2VS83cXRtMWtmbFZMZGJFclhMRW9HYWEzb2YwMUJ1VFhyTDNQMkZBaWMxUXMzCmtEcWVZb3U3VEpDczVmMFpTeWE1cXh5TVRRMzlkQkNoaG9iYXk3cHBpanRvb1ZzKzQ4azVpYlBLMDUvMk5WT2EKRzBPeWlxdGJFTXRKK2ZqdEhRcVJneDhscEhBQ2ZEc1hQMFk1cHhJNmtvbWlvdW94SCtTdzVkdm9xN1prNnY4bAplU1U5Z1lwbmwvcVRvMjFhaW9XVktqNHJaSzdaWDJWeWpkM0VuQ2o1TThCUGpRSWJJNG55L0RjTkJwS3JWZUNZCm04SGlGYzBndXV1Kzl2R1o3ZnBZRHNjSmFXcEJ2K1pIampaVGt1R2lRbDdvRFlXUXJrNlBpSUExWlhndDQ4VmEKMkVET0h3YzRnSVlwUGViMFRramN3RjR2dlRoMEN3UXYyYzlTSlZGS0ZkakQ0Ry8rUk9EdjRacTRTcUY0K0FaYQpMVnVSenRycDdUTUJEUFRralorcUJ3STFDSXNzVUtUWGh0TVFJVXg4RExCUS9NZFNtL2tSaENBWUFBbVI3aHcwCmxOaGd0bk9oaVlkY2VXbmZuSmNrSDR0bG1xK3NqdENKeU9XYTd5MkVOcFZzelhEaE50MExEcVgwNzFkL0FwK2QKNzJkZVBQRFo0MnlnSGFzWVBRc2xVTVFsK0FIMlhUMVVMU0RxZk9EVXFwaFhqVDg5OGQwZzRNQ2FIaVhibG1ENQpia3B1TllOaDZocHI5RG82c0lBNS9ja0xSTG1rRkNHeVlIRittU3d3amNKbEI2cGVOdzRkVkFRTDRnRU10ZzE0CkVFM3lOZHBmaXlwQlVSYUtTNzhFRERsdXlCbjh6aXV0M1VWY3JYNmZRNEVaL3c2TFY1eWxxaG85elB6bCtndkUKYzA4MHpQNHBXd2xZYUV0dmZjNHRYajkraVh6bXV6RzhBalMwblRoVTZJZkNqZVJwSlVlT1JYKzQwVjdlZ1lkMwpZTHdDMGE4NjJHcjZVTWhLMkhaQWZWaFprRkM0anhPdkpldEN6UzZuU3kveFNhRUt2ZU00bzY3a2I4WmtXK2RkCndYRzkyMVFIaUtraHNsTU56MTdvdFdBYWpCTlQxc0FlZDFMTk5xQW8ray9BamkxK1BlZlRrRFhNa2NPejZOb20KRUJYbHVFWDVYcnI0WHEvWUVkOTB0U3YrdGhFKzJlV2F4eEZLSE5HUHdtQ1JQcVBIVnozQ3p6M2tUN1dtUjF2agp3ZHNrdEc2TjY5YlArOTFLWlVuOHdnWlFFTG82MDBOT0toTXMvYlNhUERJZ2piTWJCSlBwSEtFYmlQS2VxYy8xCk4wMytQMFRuVzg0SnRPY2ozTUV6WXZtRlJueUp3WXhZSE1hVW00UTN4enRYV2p2NFp0VlZoamtvaHNDZkxsMUgKRjhOMlgwYjVMTGtZMDJHeUdWakhQS0EyTVV5QnR6Q1pXNGdleUJEQm53WHFPOTFCZE5XdmE5STM0OHNwaDU3NwoveWo1Rk9UaFlTdDdnSnpnS2w0a3RMb2hHRUprS2RaMmdwVWFybVdSTkxJbWM3eS9MMHFiNXQyYUp4dkFZeDIzCndKVVZ3VmZJRnlsYkl5cUxRQ1pzWXk3aGlmMEUyejhhZU9RdGFtU0F5S1Q0dHpCeVA4cEZQU3Z3SUNOMXRITEQKYS9aV1BpSlc3amt5bGM4YlR0RDZzYUtzMU1YaEZlSVF4UlFVNzZNQjcveDlqUUh5QjVORUFYK1E5S3VUL3Y3Ygp4QVdUWXpjQTJFcE9LYnVCZWJaSEZ5NWlRT0d3NTRQYldXMjdsREhpQVc0ekVqZmdUcHgxN1I1K29DWTYzUFdJCitoUzl6UVFlWVZsSllkbUt2SGorVjJEZmVtbmZ0YjJpZHJTNEtqdWJMMkJBWDR1SDhSbFVKb0VZdmxibVdONG8KVXFLRHBaMVlPTmJaT01kaGxSdVU5TktucnR5M1JzL3pQcXpxc3pWYmVBM05HNnFNL3hEVnJaWlRQRFdUTXJTSQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
  admission-cert.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURTekNDQWpPZ0F3SUJBZ0lRY3QrZXhOd1RLZkhQVGw0VktBTGZEVEFOQmdrcWhraUc5dzBCQVFzRkFEQW8KTVJJd0VBWURWUVFLRXdsVWQybHpkR3h2WTJzeEVqQVFCZ05WQkFNVENWUjNhWE4wYkc5amF6QWVGdzB5TXpBegpNamt4TWpFME1EQmFGdzB5TmpBek1qZ3hNakUwTURCYU1CUXhFakFRQmdOVkJBb1RDVlIzYVhOMGJHOWphekNDCkFTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBSjlnYy9YYVFiOGF0M2VxM0ZSN2hGTXgKbEt0QnRaUUFLcDh4VU0yYUR6REJUbUlrbThCZmg4Y3ROdlN4R2k3TWdOdS9lMUJKbE9POS80aXZ3R0h4NklRMAp1VEo4WUQyMVg4dHVMNE10aXhCdTdvN3JhSWFZbWh4OG1wUDJ6OUNoQlBlY3htbTVkTGFxMXYvbThKMzVzWjRKCitsQkhTcUVCb2RIMlJNMDJYcUliLzNGRFdmOWtUQkxlL1IvdWwrWWVyeUZVQXJCRTNOUkw4ZzM4cTFQZ1RqdlEKWDk2Q1JQaDVRc3BwMEw4Q3ZNMEVzN3M0N0xzdWVadi9ZUFlmMnIyQ1lrVzRHVUYzcytWUlRJRk5sbU9OTGJ5cQpyUnlnclhzM3czQnc0N3laWGdMOHRMNXBIbC80N21jeXJJNXQzWExsOVVRMU5QV2czMzArWWNtUGVVUlN5VTBDCkF3RUFBYU9CaERDQmdUQU9CZ05WSFE4QkFmOEVCQU1DQTZnd0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3SUcKQ0NzR0FRVUZCd01CTUF3R0ExVWRFd0VCL3dRQ01BQXdId1lEVlIwakJCZ3dGb0FVQnJ0Rk9aZFcxbTVhR2pQdwpDN1RxQ2ZqLzZzUXdJUVlEVlIwUkJCb3dHSUlXWkdWbVpXNWtaWEl1ZEhkcGMzUnNiMk5yTG5OMll6QU5CZ2txCmhraUc5dzBCQVFzRkFBT0NBUUVBQmNSdU1WRXJldjNtSVNJaEVIUVlYVWtIZ2p3Ymk4dVN2c0lLZlI3YUVjTDUKbzExK3RhWFZsaHJHOE9SWDNsVU9IYS8vQ2RyYWlUSGIwd3NrbmxqZmg4R09LNXpxcm02WlE1S2JZNVhsanNwQQpndWM1ekNEdTdYTVV6azgrNDlac2kzcis2TkYyREdPY09ydEFQSmYyMkRpM2xyUVlFNEViN1hFMEJvdFlMV04xCktaaVJFb2lhSDNKOVVYTUVwVDZXNVZvWVkzaWhhT3dXbTRhaG9FKzkxMXVqYUc5elplcGJsMVBDU3JZZ2JhUDAKaWtIOXJqWForNjUrN1EyMzdMNk5WUSt2OFFMMXduR1dGQkdqaTdMUzZxSWozV21rRll2S1FFSVVFT2hZYUdoNQpWQVI0YktsWVAzOVVGaTdWcklkSXEvSXZTUVJWa2ZIRERzVCs4YlkyQWc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  admission-key.pem: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpQcm9jLVR5cGU6IDQsRU5DUllQVEVECkRFSy1JbmZvOiBBRVMtMjU2LUNCQyw3YWQ5MDMzZTgxYTUyMjI5YWIyNjA5ZjEzNjU3M2NhMgoKQ0hUVUttZE85NzVvOERidTdiTVpuS0xLUlhLU2l1aVNsbHMrUmRkb01IT2t3d0NoNnF0Ni9CWWVNeVM5a2NkSAowY2lJbTY2c3dodFU3MFB5QzdyRWZkUmRXcGdNY0lLTW1rbXFqdFhCYjk0Uy9qdmNyRG0xMmM4N3ZpcE1US0hLCkdaaHlzTlBtYUJnNHlGbW91S0VmaG9aZEYvMVkraDJLdExaQTBRVTZFRWRZcFA5TEtiazdSWEV4eVlsRGNkcm4KMWg3TzdQTEprZFdNemp1RXFqWGsxaUV1ZkRJblNRRXY5aVRwY1cxYnQ5RURON0p5RzNoaXhTaVJlZWdsbHZIQgpjUHU2aG9IWXhhNG9XblVNS0VwMDJVempyRHBuZUZucmFHWjZpZGFmNVZxL3dNTDcxSm9sUmZHZ08zbndhRFN4Ck9TWFYzL2tzQzJoMXY2L0d3ZVJvckZrek1WLzZVdWJmdWVmSmxQRzZFQVUxMVlwVTdaa2E1emt0SjZaN21WV3AKKzVDY3I2aFhQQlU5eFBHY284QkQ4dEx6UzN6UWJadSsxU2s4NkFla3Y1NXdKYXh2NW9sbzd5Rkh1dmVybmZSQgo1MVlXOTFNNDRiREtXc3QraDRheFRTeUVVQ3F6ckFVL21talJMUERZM3JudHRCK0VNa3pSbmxXdmdsNWtxT2VKCll6VlRwK25iYjVSWTdYSWtXRnhzTTJsYTNhSy9NR0NXSXYvTmdDQVV0RXJ0eDhJWm9hQmFhWkE4cmdtR1l3VkMKTG5DcFZoRUZjWlcrYkw3TnlXMkhTdEY0RTdZcEhQcFBHMGYyQnpWcENsdExHVXdCTzVTY2pxUjV5KzM5Sm5xeQpjK0M0d256cXV1UWZHZE8ySk9JazE4TUZmdEp5L3BXcExqRFZUcDZQUDhNQjlZWXkrT1loM1N6OWFZcmRZVGk5Cnc5U2grUHRabmtIem52VWVHWEN6a0ZLL3hGak5teTZaRUJGdmNXUWU0WWtZRm5LRnFldlBROHJKSWFQeWNoUVAKK0V0aUFNeHhDSlE0bXgrK0dONy9HbGJmSTBWeVdyaHl6cnZaZWxEd0lRckh6UmxKSnVXRk9EL2ZWY0RYa1VhOQoyWE1CeUJEVXNSQUQ2eEYxQkIydEs5Y28yWTF3Z0NPYnY4Z0VVSW5zQWI3T2dTQ1NOOGlKN0s3c2hNZVN3NjdQCm5acFlHRHZseXpEdDA1aWIraFowSGJpdzl0N1oyWXRxbU5oaG5XVFpzQ09tWGhCUGhpNm9QN0tzNFZNSC93emYKdXdpS0hxQ05xbmlsc2FQeE12c0tFZXpLUzF0Sy9FU0l5SWxhRnZxaTlFMzYyWWpCTDc2ME9KOWFuSmdnc3ltUQpsMnovb1dRVWlSdFVKLyttendrelNUZHg2aFVKK3E0V3I5KzJvdlRjeHVvblNCbWptYmE4WU1MTTV3VHdMc2lkCkJ0c0NSdCtLcTdrUHUyM0RSTm1Tb1ZEQUtDZGZIaE9KcHowbGZlUTBmNDVmMXpGczY2cE90dStzZTlhTHdsMFYKZ1hKQm04TUZnUktYQUU5dnovVHhRdkdRT2FhRDFUTDFwWnRuMTZ3MFdSeUp3MVFTUWk1Yml6TnJBZDJxMGdZMgowVmpudktIampRSk9Md3ZXY1kvNWZpa1kvUkRIa2Nsa0l3Q2haR0ZLM0xWT3VHRnRIMmNxNTBSRDFMcDV3amZwCjhiaUJQTWFUZjNiYi9aZGcrRnVNWVhaOG9jOWI0THJNclE3QlJWVFNaaXBrNkl5U0x2VThOOFo2SWdUM2lMM0oKZzJUNVRibk92RkJWN3FEaDR6M2JOLzNGQmc1V0EwYmJsdmtUcjRhVnZRZzZFbHdiN042U0c4dDYweWdQMTZaTgpscG50bWVtOVRaQXBXQ3IvNWlVSzdCdWZReWxUREFwVW1vS0twWTBYeEpSMitxWTgxbFVpeDlXRUdMN3NvQ1Y3ClRvWmQ3clljb3VFa0UzcGFsNitDUXBTTS92bUJSMXJZL0R2Nk50dVk5ei9HRno0SW8zSG5ScUNmekFpUDNaU00KWnRHRGh6OHZCdUFPVjllWjdwZVE4YnIyNTBvZ0RzeGZZd0JyMk1Qd0pScWozYlJya0M3dUd3L1JId0hpbjNNVAotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=

---
apiVersion: v1
kind: ServiceAccount # Service Account is used for managing security context constraints policies in Openshift (SCC)
metadata:
  name: twistlock-service
  namespace: twistlock
secrets:
- name: twistlock-secrets
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: twistlock-defender-ds
  namespace: twistlock
spec:
  selector:
    matchLabels:
      app: twistlock-defender
  template:
    metadata:
      annotations:
        container.apparmor.security.beta.kubernetes.io/twistlock-defender: unconfined
      labels:
        app: twistlock-defender
    spec:
      serviceAccountName: twistlock-service
      restartPolicy: Always
      containers:
      - name: twistlock-defender
        image: registry-auth.twistlock.com/tw_g5aa2y5ghbyfezxjgz3lmshrvzhixs5o/twistlock/defender:defender_30_00_130
        volumeMounts:
        - name: data-folder
          mountPath: "/var/lib/twistlock"
        - name: certificates # Setting the certificates mount after data-folder since it is nested and was overridden in CRI based GKE cluster
          mountPath: "/var/lib/twistlock/certificates"
        - name: docker-sock-folder
          mountPath: "/var/vcap/sys/run/containerd"
        - name: passwd
          mountPath: "/etc/passwd"
          readOnly: true
        - name: syslog-socket
          mountPath: "/dev/log"
        - name: cri-data
          mountPath: /var/lib/containers
        - name: runc-proxy-sock-folder
          mountPath: "/run"
        env:
        - name: WS_ADDRESS
          value: wss://staging-consoles.cloud.twistlock.com:443
        - name: DEFENDER_TYPE
          value: cri
        - name: DEFENDER_LISTENER_TYPE
          value: "none"
        - name: LOG_PROD
          value: "true"
        - name: SYSTEMD_ENABLED
          value: "false"
        - name: DOCKER_CLIENT_ADDRESS
          value: "/var/vcap/sys/run/containerd/containerd.sock"
        - name: DEFENDER_CLUSTER_ID
          value: "0aead2b5-8917-b9fa-8492-0df3e0a2b242"
        - name: DEFENDER_CLUSTER
          value: "tkgi-carlos"
        - name: MONITOR_SERVICE_ACCOUNTS
          value: "true"
        - name: MONITOR_ISTIO
          value: "false"
        - name: COLLECT_POD_LABELS
          value: "false"
        - name: INSTALL_BUNDLE
          value: "eyJzZWNyZXRzIjp7fSwiZ2xvYmFsUHJveHlPcHQiOnsiaHR0cFByb3h5IjoiIiwibm9Qcm94eSI6IiIsImNhIjoiIiwidXNlciI6IiIsInBhc3N3b3JkIjp7ImVuY3J5cHRlZCI6IiJ9fSwiY3VzdG9tZXJJRCI6InBhbnctYXBwLXNhbTEwMjc4Ny0zIiwiYXBpS2V5IjoiODUzZzBWcWpyblByWGJ6cEFWdlg4cG9RbEppcEZzRE00bUExeEJJVE5iTjh4dWhMZTM5MmRmQjdyRG5hamV3YWxOVmF5WWYxclVSYmZ0STdPRmNES2c9PSIsIm1pY3Jvc2VnQ29tcGF0aWJsZSI6ZmFsc2V9"
        - name: HOST_CUSTOM_COMPLIANCE_ENABLED
          value: "true"
        - name: CLOUD_HOSTNAME_ENABLED
          value: "false"
        - name: FIPS_ENABLED
          value: "false"
        securityContext:
          readOnlyRootFilesystem: true
          privileged: false
          capabilities:
            add:
            - NET_ADMIN  # Required for process monitoring
            - NET_RAW    # Required for iptables (CNNF, runtime DNS, WAAS). See: https://bugzilla.redhat.com/show_bug.cgi?id=1895032
            - SYS_ADMIN  # Required for filesystem monitoring
            - SYS_PTRACE # Required for local audit monitoring
            - SYS_CHROOT # Required for changing mount namespace using setns
            - MKNOD      # A capability to create special files using mknod(2), used by docker-less registry scanning
            - SETFCAP    # A capability to set file capabilities, used by docker-less registry scanning
            - IPC_LOCK   # Required for perf events monitoring, allowing to ignore memory lock limits
        resources: # See: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/#how-pods-with-resource-requests-are-scheduled
          limits:
            memory: "512Mi"
            cpu: "900m"
          requests:
            cpu: "256m"
      volumes:
      - name: certificates
        secret:
          secretName: twistlock-secrets
          defaultMode: 256
      - name: syslog-socket
        hostPath:
          path: "/dev/log"
      - name: data-folder
        hostPath:
          path: "/var/lib/twistlock"
      - name: passwd
        hostPath:
          path: "/etc/passwd"
      - name: docker-sock-folder
        hostPath:
          path: "/var/vcap/sys/run/containerd"
      - name: cri-data
        hostPath:
          path: /var/lib/containers
      - name: runc-proxy-sock-folder
        hostPath:
          path: "/run"
      hostPID: true
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
---
apiVersion: v1
kind: Service # Expose the Defender as admission controller. Remark: by default, Defender will not listen on the service port
metadata:
  name: defender
  namespace: twistlock
  labels:
    app: twistlock-defender
spec:
  ports:
  - port: 443
    targetPort: 9998
  selector:
    app: twistlock-defender